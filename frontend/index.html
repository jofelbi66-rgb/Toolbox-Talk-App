<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Toolbox Talk</title>
  <style>
    /* Wichtig: verhindert Scroll/Zoom-Gesten beim Zeichnen */
#sigCanvas {
  touch-action: none;          /* Pointer Events: keine Touch-Gesten */
  -ms-touch-action: none;
  user-select: none;
  -webkit-user-select: none;
}

/* verhindert Bounce/Scroll im Signaturmodus */
body.signing {
  overflow: hidden;
  overscroll-behavior: none;
  touch-action: none;
}

    body { font-family: Arial, sans-serif; margin: 0; padding: 16px; background: #f6f6f6; }
    .card { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 16px; max-width: 720px; margin: 0 auto; }
    h1 { font-size: 18px; margin: 0 0 12px 0; }
    label { display:block; font-size: 12px; color:#333; margin-top: 12px; }
    input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; }
    button { width: 100%; margin-top: 12px; padding: 14px; border: 0; border-radius: 12px; font-size: 16px; }
    .btn { background: #1a73e8; color: #fff; }
    .btn2 { background: #e8eaed; color: #111; }
    .row { margin-top: 12px; }
    .list { margin-top: 12px; }
    .item { display:flex; justify-content:space-between; gap:12px; padding: 12px; border: 1px solid #ddd; border-radius: 12px; background:#fff; margin-bottom:10px; }
    .item.selected { border: 2px solid #1a73e8; }

    .name { font-weight: 700; }
    .company { color:#666; font-size: 12px; margin-top: 2px; }
    .status { font-size: 12px; color:#666; }
    .ok { color: #137333; font-weight:700; }
    .err { color: #b00020; font-weight:700; }
    .small { font-size: 12px; color:#666; }
  </style>
</head>

<body>
  <div class="card">
    <h1>Toolbox Talk – Dokumentation</h1>
<div class="small">
  Schritt 1: Stammdaten erfassen. Schritt 2: Teilnehmer auswählen. (Unterschriften + PDF kommen als nächstes.)
</div>

<label for="dateTime">Datum/Uhrzeit</label>
<input id="dateTime" type="datetime-local" />

<label for="site">Ort</label>
<input id="site" placeholder="z. B. Baustelle Köln" />

<label for="project">Projekt</label>
<input id="project" placeholder="z. B. Brücke Nord" />

<label for="topic">Thema</label>
<input id="topic" placeholder="z. B. Leitern & Tritte" />

<label for="trainer">Moderator</label>
<input id="trainer" placeholder="Name" />

<label for="summary">Kernaussagen</label>
<textarea id="summary" rows="5" style="width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px;"></textarea>
 <label style="display:flex; gap:10px; align-items:center; margin-top:10px;">
  <input type="checkbox" id="understood" />
  <span>Unterweisung verstanden (von allen Unterwiesenen bestätigt)</span>
</label>
   

<hr style="margin:16px 0;border:none;border-top:1px solid #eee;" />

<label for="apiUrl">Apps Script Web-App URL</label>
<input id="apiUrl" placeholder="https://script.googleusercontent.com/...." />



<div class="row">
  <div id="result" class="status">Noch nichts geladen.</div>
</div>

    <button class="btn" id="loadBtn">Teilnehmer laden</button>
    <button class="btn2" id="saveBtn">URL speichern</button>

    <div class="row">
      <div id="result" class="status">Noch nichts geladen.</div>
    </div>

    <div class="list" id="list"></div>
    <hr style="margin:16px 0;border:none;border-top:1px solid #eee;" />

<button class="btn" id="startSignBtn">Unterschriften starten (für ausgewählte)</button>
   <button class="btn" id="saveSessionBtn">Session speichern</button>
 

<div id="signPanel" class="box" style="display:none; margin-top:12px;">
  <div style="font-weight:700; font-size:16px;">Unterschrift</div>
  <div class="small" id="signInfo" style="margin-top:6px;"></div>

  <div style="margin-top:10px; border:1px solid #ccc; border-radius:12px; overflow:hidden; background:#fff;">
    <canvas id="sigCanvas" style="width:100%; height:180px; touch-action:none;"></canvas>
  </div>

  <div style="display:flex; gap:10px; margin-top:10px;">
    <button class="btn2" id="clearSigBtn" style="flex:1;">Löschen</button>
    <button class="btn" id="saveSigBtn" style="flex:2;">Speichern & Weiter</button>
  </div>

  <div class="small muted" style="margin-top:8px;">
    Tipp: iPad/Handy quer halten ist oft angenehmer zum Unterschreiben.
  </div>
</div>



  <script>
    const apiUrlInput = document.getElementById("apiUrl");
    const loadBtn = document.getElementById("loadBtn");
    const saveBtn = document.getElementById("saveBtn");
    const result = document.getElementById("result");
    const list = document.getElementById("list");
    const startSignBtn = document.getElementById("startSignBtn");
const signPanel = document.getElementById("signPanel");
const signInfo = document.getElementById("signInfo");
const sigCanvas = document.getElementById("sigCanvas");
const clearSigBtn = document.getElementById("clearSigBtn");
const saveSigBtn = document.getElementById("saveSigBtn");
  const saveSessionBtn = document.getElementById("saveSessionBtn");
  const dateTimeEl = document.getElementById("dateTime");
const siteEl = document.getElementById("site");
const projectEl = document.getElementById("project");
const topicEl = document.getElementById("topic");
const trainerEl = document.getElementById("trainer");
const summaryEl = document.getElementById("summary");
const understoodEl = document.getElementById("understood");


const selected = new Map(); // participantId -> participant (mit signatureDataUrl)


    // gespeicherte URL laden
    apiUrlInput.value = localStorage.getItem("TT_API_URL") || "";

    saveBtn.addEventListener("click", () => {
      localStorage.setItem("TT_API_URL", apiUrlInput.value.trim());
      result.innerHTML = '<span class="ok">Gespeichert.</span>';
    });

    loadBtn.addEventListener("click", async () => {
      const base = apiUrlInput.value.trim();
      if (!base) {
        result.innerHTML = '<span class="err">Bitte Web-App URL eintragen.</span>';
        return;
      }

      const url = base.includes("?") ? base + "&route=participants" : base + "?route=participants";

      result.textContent = "Lade…";
      list.innerHTML = "";
      selected.clear();


      try {
        const res = await fetch(url, { method: "GET" });
        const data = await res.json();

        if (!data.ok) {
          result.innerHTML = '<span class="err">Fehler: ' + (data.error || "unbekannt") + '</span>';
          return;
        }

        result.innerHTML = '<span class="ok">OK:</span> ' + data.participants.length + " Teilnehmer geladen.";

data.participants.forEach(p => {
  const div = document.createElement("div");
  div.className = "item";
  div.innerHTML = `
    <div>
      <div class="name">${escapeHtml(p.name)}</div>
      <div class="company">${escapeHtml(p.company)}</div>
    </div>
    <div class="status">${escapeHtml(p.participantId)}<br><span class="small">Tippen zum Auswählen</span></div>
  `;

  div.addEventListener("click", () => {
    if (selected.has(p.participantId)) {
      selected.delete(p.participantId);
      div.classList.remove("selected");
    } else {
      selected.set(p.participantId, p);
      div.classList.add("selected");
    }
    result.innerHTML = `<span class="ok">OK:</span> ${data.participants.length} geladen. <b>${selected.size}</b> ausgewählt.`;
  });

  list.appendChild(div);
});

result.innerHTML = `<span class="ok">OK:</span> ${data.participants.length} Teilnehmer geladen. <b>0</b> ausgewählt.`;


        

      } catch (e) {
        result.innerHTML = '<span class="err">Netz/JSON Fehler: </span>' + escapeHtml(String(e));
      }
    });

    function escapeHtml(s) {
      return String(s || "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    // --- Unterschriftenstraße ---
let signQueue = [];   // Array der ausgewählten Teilnehmer (Objekte)
let signIndex = 0;
let isDrawing = false;
let lastX = 0, lastY = 0;

function setupCanvas() {
  const rect = sigCanvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;

  // feste Höhe 180px; Breite kommt aus Layout
  sigCanvas.width = Math.floor(rect.width * dpr);
  sigCanvas.height = Math.floor(180 * dpr);

  const ctx = sigCanvas.getContext("2d");
  ctx.setTransform(1, 0, 0, 1, 0, 0); // reset
  ctx.scale(dpr, dpr);

  // Hintergrund weiß
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, rect.width, 180);

  // Stift
  ctx.strokeStyle = "#111";
  ctx.lineWidth = 2;
  ctx.lineCap = "round";
}

function clearCanvas() {
  const ctx = sigCanvas.getContext("2d");
  const rect = sigCanvas.getBoundingClientRect();
  ctx.clearRect(0, 0, rect.width, 180);
  ctx.fillStyle = "#fff";
  ctx.fillRect(0, 0, rect.width, 180);
}

function getPos(evt) {
  const rect = sigCanvas.getBoundingClientRect();

  // Touch-Events: touchstart/touchmove -> touches[0]
  // touchend -> changedTouches[0]
  const t = (evt.touches && evt.touches[0]) ||
            (evt.changedTouches && evt.changedTouches[0]);

  const clientX = t ? t.clientX : evt.clientX;
  const clientY = t ? t.clientY : evt.clientY;

  return {
    x: clientX - rect.left,
    y: clientY - rect.top
  };
}
function startDraw(evt) {
  if (evt.cancelable) evt.preventDefault();

  // NEU: verhindert “Weglaufen” auf dem Handy
  sigCanvas.setPointerCapture(evt.pointerId);

  const p = getPos(evt);
  isDrawing = true;
  lastX = p.x;
  lastY = p.y;
}



function moveDraw(evt) {
  if (evt.cancelable) evt.preventDefault();

  if (!isDrawing) return;

  const p = getPos(evt);
  const ctx = sigCanvas.getContext("2d");
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(p.x, p.y);
  ctx.stroke();
  lastX = p.x; lastY = p.y;
}

function endDraw(evt) {
  if (!isDrawing) return;
  evt.preventDefault();
  isDrawing = false;
  // NEU: Capture sauber freigeben
  try { sigCanvas.releasePointerCapture(evt.pointerId); } catch (e) {}
}

function openSigner(i) {
  signIndex = i;
  const p = signQueue[signIndex];
  signInfo.innerHTML = `<b>${escapeHtml(p.name)}</b> – ${escapeHtml(p.company)}<br>Person ${signIndex + 1} von ${signQueue.length}`;
  signPanel.style.display = "block";
  setupCanvas();
}

function exportSignatureDataUrl() {
  // Verkleinern auf ~400px Breite, damit Upload/PDF schlank bleibt
  const srcRect = sigCanvas.getBoundingClientRect();
  const targetW = 400;
  const targetH = Math.max(120, Math.round(targetW * (180 / srcRect.width)));

  const tmp = document.createElement("canvas");
  tmp.width = targetW;
  tmp.height = targetH;

  const tctx = tmp.getContext("2d");
  tctx.fillStyle = "#fff";
  tctx.fillRect(0, 0, targetW, targetH);
  tctx.drawImage(sigCanvas, 0, 0, targetW, targetH);

  return tmp.toDataURL("image/png");
}

startSignBtn.addEventListener("click", () => {
  if (selected.size === 0) {
    result.innerHTML = '<span class="err">Bitte erst Teilnehmer auswählen.</span>';
    return;
  }
  signQueue = Array.from(selected.values()).map(p => ({ ...p }));
  openSigner(0);
});

clearSigBtn.addEventListener("click", () => {
  clearCanvas();
});

saveSigBtn.addEventListener("click", () => {
  const p = signQueue[signIndex];
  const dataUrl = exportSignatureDataUrl();
  p.signatureDataUrl = dataUrl;

  // zurück in selected schreiben
  selected.set(p.participantId, p);

  if (signIndex + 1 < signQueue.length) {
    openSigner(signIndex + 1);
  } else {
    signPanel.style.display = "none";
    result.innerHTML = `<span class="ok">Unterschriften fertig:</span> ${selected.size} Personen unterschrieben.`;
  }
});


// Events: Pointer (Maus + Touch + Stift) – stabil auf Mobile
sigCanvas.style.touchAction = "none";

sigCanvas.addEventListener("pointerdown", startDraw);
sigCanvas.addEventListener("pointermove", moveDraw);
window.addEventListener("pointerup", endDraw);
window.addEventListener("pointercancel", endDraw);


function getSessionPayloadFromUi() {
  const participants = Array.from(selected.values()).map(p => ({
    participantId: p.participantId,
    name: p.name,
    company: p.company,
    signatureDataUrl: p.signatureDataUrl || ""
  }));

  return {
    dateTime: dateTimeEl.value,
    site: siteEl.value.trim(),
    project: projectEl.value.trim(),
    topic: topicEl.value.trim(),
    trainer: trainerEl.value.trim(),
    summary: summaryEl.value.trim(),
    understood: !!understoodEl.checked,
    participants
  };
}

function validateBeforeSave(session) {
  if (!session.dateTime) throw new Error("Datum/Uhrzeit fehlt.");
  if (!session.topic) throw new Error("Thema fehlt.");
  if (!session.trainer) throw new Error("Moderator fehlt.");
  if (!session.participants.length) throw new Error("Keine Teilnehmer ausgewählt.");
  const missing = session.participants.filter(p => !p.signatureDataUrl);
  if (missing.length) throw new Error("Unterschrift fehlt bei: " + missing.map(m => m.name).join(", "));
}
saveSessionBtn.addEventListener("click", async () => {
  const base = apiUrlInput.value.trim();
  if (!base) {
    result.innerHTML = '<span class="err">Bitte Web-App URL eintragen.</span>';
    return;
  }

  try {
    const session = getSessionPayloadFromUi();
    validateBeforeSave(session);

    result.textContent = "Speichere Session…";

    const sessionParam = encodeURIComponent(JSON.stringify(session));
    const url = base.includes("?")
      ? `${base}&route=session.create&session=${sessionParam}`
      : `${base}?route=session.create&session=${sessionParam}`;

    const res = await fetch(url, { method: "GET" });
    const data = await res.json();

    if (!data.ok) {
      result.innerHTML = '<span class="err">Fehler: ' + escapeHtml(data.error || "unbekannt") + '</span>';
      return;
    }

    localStorage.setItem("TT_SESSION_ID", data.sessionId);
    result.innerHTML = `<span class="ok">Session gespeichert.</span> Session-ID: <b>${escapeHtml(data.sessionId)}</b>`;
  } catch (e) {
    result.innerHTML = '<span class="err">Fehler: </span>' + escapeHtml(String(e.message || e));
  }
});



  </script>
</body>
</html>
